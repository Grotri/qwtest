name: Conventional Commits Check
on: [push, pull_request]

jobs:
  check-commits:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # –ü–æ–ª–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –¥–ª—è —Ç–æ—á–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏

      - name: Validate commit messages
        run: |
          TYPES="chore|docs|feat|fix|refactor|revert|style|test"
          HEADER_PATTERN="^($TYPES)(\([a-z0-9-]+\))?:[[:space:]]*.+"
          FOOTER_PATTERN="^[A-Z]+-[0-9]+$"
          
          ERROR_MSG="‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–º–º–∏—Ç–∞! –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
          1. –ü–µ—Ä–≤–∞—è —Å—Ç—Ä–æ–∫–∞: <—Ç–∏–ø>(<–æ–±–ª–∞—Å—Ç—å>): <–æ–ø–∏—Å–∞–Ω–∏–µ>
             –ü—Ä–∏–º–µ—Ä: 'fix: –∏—Å–ø—Ä–∞–≤–∏—Ç—å –±–∞–≥' –∏–ª–∏ 'feat(api): –¥–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥'
             –î–æ–ø—É—Å–∫–∞–µ—Ç—Å—è: 'fix: fix regex'
          2. –ü–æ—Å–ª–µ–¥–Ω—è—è —Å—Ç—Ä–æ–∫–∞: 'QW-52' (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
          3. –ú–µ–∂–¥—É –Ω–∏–º–∏ –º–æ–∂–µ—Ç –±—ã—Ç—å –ª—é–±–æ–π —Ç–µ–∫—Å—Ç (–∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç—Å—è)"

          # –û—Ç–ª–∞–¥–∫–∞: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –≤–µ—Ç–∫–∏
          echo "üîç –î–æ—Å—Ç—É–ø–Ω—ã–µ –≤–µ—Ç–∫–∏:"
          git branch -r

          # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ SHA –∫–æ–º–º–∏—Ç–æ–≤
          if [ "$GITHUB_EVENT_NAME" = "push" ]; then
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ –∫–æ–º–º–∏—Ç—ã –≤ –ø—É—àe
            COMMIT_SHAS=$(git rev-list --no-merges $GITHUB_BEFORE..$GITHUB_SHA)
          else
            # –î–ª—è PR: –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ–º –±–∞–∑–æ–≤—É—é –≤–µ—Ç–∫—É –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–º–º–∏—Ç—ã
            git fetch origin $GITHUB_BASE_REF:$GITHUB_BASE_REF
            COMMIT_SHAS=$(git rev-list --no-merges $GITHUB_BASE_REF..$GITHUB_HEAD_REF)
          fi

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–ø–∏—Å–æ–∫ –∫–æ–º–º–∏—Ç–æ–≤ –Ω–µ –ø—É—Å—Ç–æ–π
          if [ -z "$COMMIT_SHAS" ]; then
            echo "‚ùå –û—à–∏–±–∫–∞: –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –∫–æ–º–º–∏—Ç–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏"
            exit 1
          fi

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–π –∫–æ–º–º–∏—Ç
          for sha in $COMMIT_SHAS; do
            commit=$(git log -1 --format=%B "$sha")
            echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–º–º–∏—Ç $sha:"
            echo "---"
            echo "$commit"
            echo "---"
            
            # –£–¥–∞–ª—è–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏
            cleaned_commit=$(echo "$commit" | sed '/^$/d')
            first_line=$(echo "$cleaned_commit" | head -n 1)
            last_line=$(echo "$cleaned_commit" | tail -n 1)
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å—Ç—Ä–æ–∫–∏ –Ω–µ –ø—É—Å—Ç—ã–µ
            if [ -z "$first_line" ] || [ -z "$last_line" ]; then
              echo "‚ùå –û—à–∏–±–∫–∞: –∫–æ–º–º–∏—Ç –ø—É—Å—Ç–æ–π –∏–ª–∏ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–∂–∏–¥–∞–µ–º—ã—Ö —Å—Ç—Ä–æ–∫"
              echo "---"
              echo "$commit"
              echo "---"
              echo "$ERROR_MSG"
              exit 1
            fi
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ä–º–∞—Ç
            if ! [[ "$first_line" =~ $HEADER_PATTERN ]] || ! [[ "$last_line" =~ $FOOTER_PATTERN ]]; then
              echo "‚ùå –û—à–∏–±–∫–∞ –≤ –∫–æ–º–º–∏—Ç–µ $sha:"
              echo "---"
              echo "$commit"
              echo "---"
              echo "$ERROR_MSG"
              exit 1
            fi
            echo "‚úÖ –ö–æ–º–º–∏—Ç $sha –≤–∞–ª–∏–¥–µ–Ω"
          done
